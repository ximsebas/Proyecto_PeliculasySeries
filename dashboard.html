<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Dashboard - Buscador Pel√≠culas y Series</title>
    <link rel="stylesheet" href="./css/style.css" />
  </head>
  <body>
    <div class="dashboard-container">
      <header class="dashboard-header">
        <h1>üé¨ Buscador de Pel√≠culas y Series</h1>
        <div class="user-info">
          <a href="favorites.html" class="btn-favorites">‚ù§Ô∏è Mis Favoritos</a>
          <span id="userName">Usuario</span>
          <a href="index.html" class="btn-logout">Cerrar Sesi√≥n</a>
        </div>
      </header>

      <main class="container">
        <div class="search-section">
          <h2>Buscar Pel√≠culas y Series</h2>
          <div class="search-box">
            <input
              type="text"
              id="searchInput"
              placeholder="Ej: Avengers, Titanic, The Godfather..."
            />
            <button id="searchBtn">Buscar</button>
          </div>
        </div>

        <div id="loading" style="display: none; text-align: center">
          <p>Buscando pel√≠culas...</p>
        </div>

        <div id="movies-container" class="movies-grid">
          <p class="placeholder">
            Ingresa el nombre de una pel√≠cula para buscar
          </p>
        </div>
      </main>
    </div>

    <!-- Modal para sinopsis -->
    <div id="movieModal" class="modal">
      <div class="modal-content">
        <span class="close">&times;</span>
        <div id="modal-body">
          <!-- Aqu√≠ se cargar√° la informaci√≥n de la pel√≠cula -->
        </div>
      </div>
    </div>

    <script>
      // API Key de OMDB - QUE YA FUNCIONABA
      const API_KEY = "eaa6e858";
      const API_URL = "https://www.omdbapi.com/";

      // Elementos del DOM
      const searchInput = document.getElementById("searchInput");
      const searchBtn = document.getElementById("searchBtn");
      const moviesContainer = document.getElementById("movies-container");
      const loading = document.getElementById("loading");
      const modal = document.getElementById("movieModal");
      const closeBtn = document.querySelector(".close");

      // Inicializar modal
      function initModal() {
        if (closeBtn) {
          closeBtn.addEventListener("click", () => {
            modal.style.display = "none";
          });
        }

        window.addEventListener("click", (e) => {
          if (e.target === modal) {
            modal.style.display = "none";
          }
        });
      }

      // Funci√≥n para buscar pel√≠culas
      async function searchMovies(query) {
        if (!query.trim()) {
          showMessage("Por favor ingresa un t√©rmino de b√∫squeda");
          return;
        }

        loading.style.display = "block";
        moviesContainer.innerHTML = "";

        try {
          const response = await fetch(
            `${API_URL}?apikey=${API_KEY}&s=${encodeURIComponent(query)}`
          );
          const data = await response.json();

          loading.style.display = "none";

          if (data.Response === "True") {
            displayMovies(data.Search);
          } else {
            showMessage(
              "‚ùå No se encontraron pel√≠culas Intenta con otro nombre."
            );
          }
        } catch (error) {
          loading.style.display = "none";
          showMessage("‚ùå Error al buscar pel√≠culas. Revisa tu conexi√≥n.");
          console.error("Error:", error);
        }
      }

      // Funci√≥n para mostrar pel√≠culas
      function displayMovies(movies) {
        moviesContainer.innerHTML = movies
          .map((movie) => {
            // Escapar correctamente todos los campos
            const safeMovieId = movie.imdbID
              .replace(/'/g, "\\'")
              .replace(/"/g, '\\"');
            const safeTitle = movie.Title.replace(/'/g, "\\'").replace(
              /"/g,
              '\\"'
            );
            const safePoster = (
              movie.Poster !== "N/A"
                ? movie.Poster
                : "https://via.placeholder.com/300x450/cccccc/666666?text=Poster+No+Disponible"
            )
              .replace(/'/g, "\\'")
              .replace(/"/g, '\\"');
            const safeYear = movie.Year.replace(/'/g, "\\'").replace(
              /"/g,
              '\\"'
            );

            return `
            <div class="movie-card" onclick="showMovieDetails('${safeMovieId}')">
                <img src="${safePoster}" 
                     alt="${movie.Title}"
                     onerror="this.src='https://via.placeholder.com/300x450/cccccc/666666?text=Poster+No+Disponible'">
                <h3>${movie.Title}</h3>
                <p><strong>A√±o:</strong> ${movie.Year}</p>
                <p><strong>Tipo:</strong> ${movie.Type}</p>
                <button class="btn-favorite" onclick="event.stopPropagation(); addToFavorites('${safeMovieId}', '${safeTitle}', '${safePoster}', '${safeYear}')">
                    ‚ù§Ô∏è Agregar a Favoritos
                </button>
            </div>
        `;
          })
          .join("");
      }

      // Funci√≥n para mostrar mensajes
      function showMessage(message) {
        moviesContainer.innerHTML = `<div class="message">${message}</div>`;
      }

      // Verificar si el usuario est√° logueado
      async function checkSession() {
        try {
          const response = await fetch("./php/check_session.php");
          const result = await response.json();

          if (!result.logged_in) {
            alert("Debes iniciar sesi√≥n para usar esta funci√≥n");
            window.location.href = "login.html";
            return false;
          }

          // Actualizar nombre de usuario en el header
          if (result.user_name) {
            document.getElementById("userName").textContent = result.user_name;
          }

          return true;
        } catch (error) {
          console.error("Error verificando sesi√≥n:", error);
          return false;
        }
      }

      // Funci√≥n agregar a favoritos - VERSI√ìN FUNCIONAL
      async function addToFavorites(
        movieId,
        movieTitle,
        moviePoster,
        movieYear
      ) {
        // Verificar sesi√≥n primero
        const isLoggedIn = await checkSession();
        if (!isLoggedIn) return;

        console.log("=== DEBUG ADD TO FAVORITES ===");
        console.log("Movie ID:", movieId, "Type:", typeof movieId);
        console.log("Movie Title:", movieTitle);
        console.log("Movie Poster:", moviePoster);
        console.log("Movie Year:", movieYear);

        // SOLUCI√ìN TEMPORAL: Si movieId es inv√°lido, usar timestamp como ID
        if (
          !movieId ||
          movieId === "undefined" ||
          movieId === "null" ||
          movieId === "0"
        ) {
          console.warn("‚ö†Ô∏è Movie ID inv√°lido, usando ID temporal");
          movieId = Date.now(); // ID √∫nico basado en timestamp
        }

        try {
          const response = await fetch("./php/add_favorite.php", {
            method: "POST",
            headers: {
              "Content-Type": "application/x-www-form-urlencoded",
            },
            body: `movie_id=${encodeURIComponent(
              movieId
            )}&movie_title=${encodeURIComponent(
              movieTitle
            )}&movie_poster=${encodeURIComponent(
              moviePoster
            )}&movie_year=${encodeURIComponent(movieYear)}`,
          });

          const result = await response.json();
          console.log("Respuesta del servidor:", result);

          if (result.success) {
            alert(`üéâ "${movieTitle}" agregada a favoritos!`);
          } else {
            alert(`‚ö†Ô∏è ${result.message}`);
          }
        } catch (error) {
          alert("‚ùå Error al agregar a favoritos");
          console.error("Error:", error);
        }
      }

      // Funci√≥n para actualizar la UI despu√©s de agregar favorito
      function updateFavoritesUI() {
        // Aqu√≠ puedes actualizar botones o indicadores visuales
        console.log("UI actualizada - pel√≠cula agregada a favoritos");
      }

      // Verificar sesi√≥n al cargar la p√°gina
      document.addEventListener("DOMContentLoaded", async function () {
        await checkSession();
      });

      // Funci√≥n para mostrar detalles de la pel√≠cula
      async function showMovieDetails(movieId) {
        try {
          const response = await fetch(
            `${API_URL}?apikey=${API_KEY}&i=${movieId}&plot=full`
          );
          const movie = await response.json();

          if (movie.Response === "True") {
            displayMovieModal(movie);
          } else {
            alert("Error al cargar detalles de la pel√≠cula");
          }
        } catch (error) {
          console.error("Error:", error);
          alert("Error al cargar detalles");
        }
      }

      // Funci√≥n para mostrar el modal con la informaci√≥n
      function displayMovieModal(movie) {
        const modalBody = document.getElementById("modal-body");
        const safeTitle = movie.Title.replace(/'/g, "\\'");

        modalBody.innerHTML = `
                <div class="movie-details">
                    <img src="${
                      movie.Poster !== "N/A"
                        ? movie.Poster
                        : "https://via.placeholder.com/300x450/cccccc/666666?text=Poster+No+Disponible"
                    }" 
                         alt="${movie.Title}">
                    <div class="movie-info">
                        <h2>${movie.Title} (${movie.Year})</h2>
                        <div class="movie-meta">
                            <p><strong>G√©nero:</strong> ${movie.Genre}</p>
                            <p><strong>Duraci√≥n:</strong> ${movie.Runtime}</p>
                            <p><strong>Director:</strong> ${movie.Director}</p>
                            <p><strong>Actores:</strong> ${movie.Actors}</p>
                            <p><strong>Clasificaci√≥n:</strong> ${
                              movie.Rated
                            }</p>
                            ${
                              movie.Ratings && movie.Ratings.length > 0
                                ? `<div class="rating"><strong>Rating:</strong> ${movie.Ratings[0].Value}</div>`
                                : ""
                            }
                        </div>
                    </div>
                </div>
                <div class="plot">
                    <h3>Sinopsis</h3>
                    <p>${
                      movie.Plot !== "N/A"
                        ? movie.Plot
                        : "Sinopsis no disponible"
                    }</p>
                </div>
                <button class="btn-favorite" onclick="addToFavorites('${
                  movie.imdbID
                }', '${safeTitle}', '${movie.Poster}', '${movie.Year}')">
                    ‚ù§Ô∏è Agregar a Favoritos
                </button>
            `;

        modal.style.display = "block";
      }

      // Event Listeners
      searchBtn.addEventListener("click", () => {
        searchMovies(searchInput.value);
      });

      searchInput.addEventListener("keypress", (e) => {
        if (e.key === "Enter") {
          searchMovies(searchInput.value);
        }
      });

      // Inicializar la aplicaci√≥n
      initModal();
    </script>
  </body>
</html>
